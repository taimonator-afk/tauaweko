<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tau Āweko - Te Whare o Raukura</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script type="module" src="firebase-setup.js"></script>

    <style>
        /* Modal overlay */
        #nameModalOverlay {
            backdrop-filter: blur(6px);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-800 via-blue-900 to-slate-900">

<div id="app"></div>

<!-- Name Modal -->
<div id="nameModalOverlay"
     class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">

    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
        <h2 class="text-2xl font-bold text-blue-900 mb-4">Ko wai koe?</h2>
        <p class="text-gray-600 mb-6">(What is your name?)</p>

        <input id="displayNameInput"
               type="text"
               placeholder="Enter your name"
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4">

        <button id="saveDisplayNameBtn"
                class="w-full bg-blue-900 hover:bg-blue-800 text-white py-2 rounded-lg font-semibold">
            Save Name
        </button>
    </div>

</div>

<script type="module">
/* ---------------------------------------------------------
   IMPORTS
--------------------------------------------------------- */
import {
    auth,
    db,
    onAuthStateChanged,
    signOut,
    doc,
    getDoc,
    setDoc,
    updateDoc
} from "./firebase-setup.js";

/* ---------------------------------------------------------
   GLOBAL STATE
--------------------------------------------------------- */
let state = {
    firebaseUser: null,       // Firebase auth user object
    displayName: null,        // Māori name
    userProgress: {},         // lessons, assessments, interactive stats
    currentView: 'loading',   // loading → dashboard/other
    assessmentQuestions: [],
    assessmentAnswers: {},
    assessmentUnlocked: false,
    assessmentSubmitted: false,
    interactiveProblem: null,
    interactiveFeedback: ''
};

/* ---------------------------------------------------------
   FIRESTORE HELPERS
--------------------------------------------------------- */
async function loadUserProfile(uid) {
    const ref = doc(db, "profiles", uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) return null;
    return snap.data();
}

async function saveUserProfile(uid, data) {
    await setDoc(doc(db, "profiles", uid), data, { merge: true });
}

async function loadUserProgress(uid) {
    const ref = doc(db, "progress", uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) return {};
    return snap.data();
}

async function saveUserProgress(uid, data) {
    await setDoc(doc(db, "progress", uid), data, { merge: true });
}

/* ---------------------------------------------------------
   HANDLE NAME MODAL
--------------------------------------------------------- */
function openNameModal() {
    document.getElementById("nameModalOverlay").classList.remove("hidden");
}

async function saveDisplayName() {
    const name = document.getElementById("displayNameInput").value.trim();
    if (!name) return alert("Please enter your name.");

    await saveUserProfile(state.firebaseUser.uid, { displayName: name });

    state.displayName = name;
    document.getElementById("nameModalOverlay").classList.add("hidden");

    // Continue to dashboard
    state.currentView = "dashboard";
    render();
}

document.getElementById("saveDisplayNameBtn").onclick = saveDisplayName;

/* ---------------------------------------------------------
   AUTH LISTENER — MAIN ENTRY POINT
--------------------------------------------------------- */
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        // If no user, force login page
        window.location.href = "login.html";
        return;
    }

    state.firebaseUser = user;
    state.currentView = "loading";
    render();

    // Load Name
    const profile = await loadUserProfile(user.uid);

    if (!profile || !profile.displayName) {
        openNameModal();
        return;
    }

    state.displayName = profile.displayName;

    // Load Progress
    state.userProgress = await loadUserProgress(user.uid) || {};

    // Go to dashboard
    state.currentView = "dashboard";
    render();
});
</script>
