<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tau ƒÄweko ‚Äì Teacher Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="./firebase-setup.js"></script>

  <style>
    .badge-green { background: #dcfce7; color: #166534; }
    .badge-yellow { background: #fef9c3; color: #854d0e; }
    .badge-red { background: #fee2e2; color: #991b1b; }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-800 to-blue-900 min-h-screen text-white p-6">

  <div class="max-w-7xl mx-auto">
    
    <!-- HEADER -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-4xl font-extrabold">Tau ƒÄweko ‚Äì Teacher Dashboard</h1>

      <div class="flex items-center gap-3">
        <!-- Navigation Buttons -->
        <a href="teacher-classes.html"
          class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
          üìö Manage Classes
        </a>

        <a href="teacher-analytics.html"
          class="px-4 py-2 bg-blue-900 text-white rounded-lg hover:bg-blue-700 font-semibold">
          üìä View Analytics
        </a>

        <button id="logoutBtn" 
          class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-semibold">
          Logout
        </button>
      </div>
    </div>


    <!-- TABLE CARD -->
    <div class="bg-white text-black p-6 rounded-xl shadow-xl">
      <h2 class="text-2xl font-bold mb-6">Class Overview</h2>

      <table class="w-full border-collapse">
        <thead>
          <tr class="border-b font-bold bg-gray-100">
            <th class="p-2 text-left">Name</th>
            <th class="p-2 text-left">Email</th>
            <th class="p-2 text-center">Lessons</th>
            <th class="p-2 text-center">Assessment</th>
            <th class="p-2 text-center">Interactive</th>
            <th class="p-2 text-center">Last Login</th>
          </tr>
        </thead>
        <tbody id="studentRows" class="divide-y">
          <!-- Filled dynamically -->
        </tbody>
      </table>

      <button id="exportCSV" 
        class="mt-6 px-4 py-2 bg-blue-900 text-white rounded-lg hover:bg-blue-700">
        Export CSV
      </button>
    </div>

  </div>

  <!-- Assessment Details Modal -->
  <div id="assessmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-6">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white">
        <h3 class="text-2xl font-bold text-blue-900">Assessment Details</h3>
        <button onclick="closeAssessmentModal()" class="text-gray-500 hover:text-gray-700 text-3xl">√ó</button>
      </div>
      <div id="modalContent" class="p-6">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>


  <!-- JAVASCRIPT -->
  <script type="module">
    import {
      auth, db,
      onAuthStateChanged, signOut,
      collection, getDocs, doc, getDoc
    } from "./firebase-setup.js";

    const studentRows = document.getElementById("studentRows");

    /* ---------------------------------------------
       AUTH GUARD
    --------------------------------------------- */
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      // Optional restriction:
      // if (user.email !== "taimonator@gmail.com") window.location.href = "tau-aweko.html";

      loadAllStudents();
    });


    /* ---------------------------------------------
       LOAD ALL STUDENT PROFILES + PROGRESS
    --------------------------------------------- */
    async function loadAllStudents() {

      const profilesSnap = await getDocs(collection(db, "profiles"));
      const progressSnap = await getDocs(collection(db, "progress"));

      const profiles = {};
      const progress = {};

      profilesSnap.forEach(docSnap => profiles[docSnap.id] = docSnap.data());
      progressSnap.forEach(docSnap => progress[docSnap.id] = docSnap.data());

      const rows = [];

      for (const uid of Object.keys(profiles)) {
        const p = profiles[uid];
        const prog = progress[uid] || {};

        const lessons = prog.lessons || {};
        const assessments = prog.assessments?.raukura || null;
        const interactive = prog.interactive || { attempted: 0, correct: 0 };

        const completedLessons = Object.keys(lessons).length;

        rows.push({
          uid,
          name: p.displayName || "(No name)",
          email: p.email || "(No email)",
          lessons: `${completedLessons} / 3`,
          assessmentScore: assessments ? `${assessments.score}%` : "‚Äî",
          assessmentData: assessments || null, // Store full assessment data
          attempts: interactive.attempted || 0,
          correct: interactive.correct || 0,
          lastLogin: p.lastLogin || "(Unknown)"
        });
      }

      renderTable(rows);
      window._allRows = rows; // For CSV export
    }


    /* ---------------------------------------------
       RENDER TABLE
    --------------------------------------------- */
    function renderTable(rows) {
      studentRows.innerHTML = rows.map((r, index) => `
        <tr>
          <td class="p-2 font-semibold">
            <a href="student-profile.html?uid=${r.uid}" 
               class="text-blue-700 underline hover:text-blue-500">
               ${r.name}
            </a>
          </td>

          <td class="p-2 text-sm text-gray-700">${formatEmail(r.email)}</td>

          <td class="p-2 text-center">
            ${renderBadge_Lessons(r.lessons)}
          </td>

          <td class="p-2 text-center">
            ${renderBadge_Assessment(r.assessmentScore, index, r.assessmentData)}
          </td>

          <td class="p-2 text-center">
            <span class="badge-yellow px-2 py-1 rounded-lg">
              ${r.correct}/${r.attempts}
            </span>
          </td>

          <td class="p-2 text-center text-sm text-gray-600">${r.lastLogin}</td>
        </tr>
      `).join("");
    }


    /* ---------------------------------------------
       BADGE HELPERS
    --------------------------------------------- */
    function renderBadge_Lessons(v) {
      const count = Number(v.split("/")[0]);

      if (count === 3)
        return `<span class="badge-green px-2 py-1 rounded-lg">${v}</span>`;

      if (count === 0)
        return `<span class="badge-red px-2 py-1 rounded-lg">${v}</span>`;

      return `<span class="badge-yellow px-2 py-1 rounded-lg">${v}</span>`;
    }

    function renderBadge_Assessment(score, index, assessmentData) {
      if (score === "‚Äî")
        return `<span class="badge-red px-2 py-1 rounded-lg">Not done</span>`;

      const num = Number(score.replace("%",""));
      const badgeClass = num >= 80 ? "badge-green" : num >= 50 ? "badge-yellow" : "badge-red";
      
      // Make it clickable if there's detailed data
      if (assessmentData && assessmentData.detailedResults) {
        return `<button onclick="showAssessmentDetails(${index})" 
                  class="${badgeClass} px-2 py-1 rounded-lg cursor-pointer hover:opacity-80 underline">
                  ${score} (view)
                </button>`;
      }
      
      return `<span class="${badgeClass} px-2 py-1 rounded-lg">${score}</span>`;
    }

    /* ---------------------------------------------
       SHOW ASSESSMENT DETAILS MODAL
    --------------------------------------------- */
    window.showAssessmentDetails = function(rowIndex) {
      const row = window._allRows[rowIndex];
      const assessment = row.assessmentData;
      
      if (!assessment || !assessment.detailedResults) {
        alert("No detailed results available.");
        return;
      }

      const results = assessment.detailedResults;
      const studentName = row.name;

      const resultsHTML = results.map((r, i) => `
        <div class="p-4 rounded-lg mb-3 ${r.isCorrect ? 'bg-green-50 border-l-4 border-green-500' : 'bg-red-50 border-l-4 border-red-500'}">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <p class="font-semibold text-gray-800 mb-2">${r.question}</p>
              <p class="text-sm text-gray-600">
                <span class="font-medium">Student answer:</span> 
                <span class="${r.isCorrect ? 'text-green-700' : 'text-red-700'}">${r.studentAnswer}</span>
              </p>
              ${!r.isCorrect ? `
                <p class="text-sm text-gray-600 mt-1">
                  <span class="font-medium">Correct answer:</span> 
                  <span class="text-green-700">${r.correctAnswer}</span>
                </p>
              ` : ''}
            </div>
            <div class="ml-4">
              ${r.isCorrect ? '<span class="text-3xl">‚úÖ</span>' : '<span class="text-3xl">‚ùå</span>'}
            </div>
          </div>
        </div>
      `).join('');

      const content = `
        <div class="mb-6">
          <h4 class="text-xl font-bold text-gray-800 mb-2">${studentName}</h4>
          <div class="bg-blue-50 p-4 rounded-lg">
            <p class="text-lg"><strong>Score:</strong> <span class="text-2xl font-bold text-blue-900">${assessment.score}%</span></p>
            <p class="text-gray-700">${assessment.correctAnswers} out of ${assessment.totalQuestions} correct</p>
            <p class="text-sm text-gray-600">Completed: ${new Date(assessment.completedAt).toLocaleString('en-NZ')}</p>
          </div>
        </div>

        <div>
          <h4 class="text-lg font-bold text-gray-800 mb-3">Question-by-Question Results:</h4>
          ${resultsHTML}
        </div>
      `;

      document.getElementById("modalContent").innerHTML = content;
      document.getElementById("assessmentModal").classList.remove("hidden");
    };

    window.closeAssessmentModal = function() {
      document.getElementById("assessmentModal").classList.add("hidden");
    };

    // Close modal when clicking outside
    document.getElementById("assessmentModal")?.addEventListener("click", function(e) {
      if (e.target === this) {
        closeAssessmentModal();
      }
    });

    function formatEmail(email) {
      if (!email || email === "(No email)") return email;
      return `<a href="mailto:${email}" class="underline">${email}</a>`;
    }


    /* ---------------------------------------------
       CSV EXPORT
    --------------------------------------------- */
    document.getElementById("exportCSV").onclick = function () {
      const rows = window._allRows || [];
      let csv = "Name,Email,Lessons,Assessment,Correct,Attempted,Last Login\n";

      rows.forEach(r => {
        csv += `${r.name},${r.email},${r.lessons},${r.assessmentScore},${r.correct},${r.attempts},${r.lastLogin}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "tau-aweko-students.csv";
      a.click();
    };


    /* ---------------------------------------------
       LOGOUT
    --------------------------------------------- */
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      window.location.href = "login.html";
    };

  </script>

</body>
</html>
